<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết tin tức - @Model.TieuDe</title>
    <link href="~/css/siteChiTietTinTuc.css" rel="stylesheet" />
</head>
<body>
    <div class="page-container">
        <div class="content-wrapper">
            <div class="detail-container">
                <!-- Main Content (Chi tiết tin tức) - CHỈ TÍNH PHẦN NÀY -->
                <div class="main-content">
                    <h1>@Model.TieuDe</h1>
                    <div class="news-meta">
                        <span class="news-category">@Model.LoaiTinTuc?.TenLoaiTinTuc</span>
                        <span>Ngày đăng: @Model.NgayDang.ToString("dd/MM/yyyy")</span> |
                        <span id="viewCount">Lượt xem: @Model.LuotXem</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.DuongDanHinhAnh))
                    {
                        <img src="/asset/@Model.DuongDanHinhAnh" alt="@Model.TieuDe" class="news-image">
                    }
                    else
                    {
                        <img src="https://via.placeholder.com/800x400" alt="Hình ảnh mặc định" class="news-image">
                    }

                    <div class="news-content" id="newsContent">@Model.MoTa</div>
                </div>

                <!-- Right Sidebar (CHỈ HIỂN THỊ - KHÔNG TÍNH LƯỢT XEM) -->
                <div class="right-sidebar">
                    <h3>Tin tức nổi bật theo lượt xem</h3>
                    @if (ViewBag.TopViewedNews != null && ((IEnumerable<TinTucModel>)ViewBag.TopViewedNews).Any())
                    {
                        foreach (var item in ViewBag.TopViewedNews)
                        {
                            <div class="top-viewed-item">
                                <h4><a href="@Url.Action("Detail", "TinTuc", new { id = item.MaTinTuc })">@item.TieuDe</a></h4>
                                <div class="views">Lượt xem: @item.LuotXem</div>
                            </div>
                        }
                    }
                    else
                    {
                        <p>Không có tin tức nào để hiển thị.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <script>
        // Lớp quản lý theo dõi lượt xem - CHỈ CHO MAIN-CONTENT
        class MainContentViewTracker {
            constructor() {
                this.currentNewsId = @Model.MaTinTuc;
                this.startTime = new Date();
                this.minReadTime = 60000; // 1 phút đọc main-content
                this.viewCounted = false;
                this.isPageActive = true;

                this.initializeTracking();
            }

            initializeTracking() {
                console.log('Bắt đầu theo dõi main-content cho tin:', this.currentNewsId);

                // Sau 1 phút, tăng lượt xem
                setTimeout(() => {
                    if (this.isPageActive && !this.viewCounted) {
                        this.updateViewCount();
                    }
                }, this.minReadTime);

                // Theo dõi khi user rời trang hoặc chuyển tab
                document.addEventListener('visibilitychange', () => {
                    this.isPageActive = !document.hidden;
                });

                // Không cần theo dõi click sidebar vì không ảnh hưởng đến logic
            }

            updateViewCount() {
                if (this.viewCounted) return; // Tránh tăng nhiều lần

                console.log('Cập nhật lượt xem cho main-content tin:', this.currentNewsId);

                fetch('/TinTuc/UpdateView', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(this.currentNewsId)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.viewCounted = true;
                            console.log('Lượt xem đã tăng lên:', data.luotXem);

                            // Cập nhật hiển thị
                            const viewCountElement = document.getElementById('viewCount');
                            if (viewCountElement) {
                                viewCountElement.textContent = `Lượt xem: ${data.luotXem}`;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi cập nhật lượt xem:', error);
                    });
            }

            // Method để debug
            forceUpdateView() {
                this.viewCounted = false;
                this.updateViewCount();
            }
        }

        // Khởi tạo tracking CHỈ cho main-content
        const mainContentTracker = new MainContentViewTracker();

        // Xử lý định dạng nội dung
        document.addEventListener('DOMContentLoaded', function () {
            const newsContent = document.getElementById('newsContent');
            if (newsContent) {
                let content = newsContent.textContent || newsContent.innerText;

                let lines = content.split('\n');
                let formattedLines = [];

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();

                    if (line === '') {
                        continue;
                    }

                    if (/^\d+(\.\d+)*\.\s/.test(line)) {
                        formattedLines.push('<strong>' + line + '</strong>');
                    } else {
                        formattedLines.push('<p>' + line + '</p>');
                    }
                }

                newsContent.innerHTML = formattedLines.join('');
            }
        });

        // Hàm debug - test tăng lượt xem ngay lập tức
        function testViewUpdate() {
            mainContentTracker.forceUpdateView();
        }

        // Hàm debug - reset cookies
        function resetViewTracking() {
            document.cookie.split(";").forEach(function (c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            console.log('Đã xóa tất cả cookies tracking');
        }
    </script>
</body>
</html>