@model dynamic
@{
    ViewData["Title"] = "TrangCaNhan";
    // var soTienConThieu = TempData["SoTienConThieu"]?.ToString() ?? "0";
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/siteTrangCaNhan.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="main-container">
        <div class="leftSidebar">
            <div class="account-header">
                <div class="account-name" id="account-name">@ViewBag.HoTen</div>
                <div class="account-type">Tài khoản thưởng</div>
            </div>

            <div class="balance-section">
                <div class="balance-title">Số dư tài khoản</div>
                <div class="balance-item">
                    <span id="balance-amount" data-amount="@ViewBag.SoDu">****</span> 
                    <button id="toggle-balance-btn" class="toggle-balance-btn">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>


            <div class="menu-section">
                <div class="sub-menu">
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "profile" ? "active" : "")" data-target="profile">
                        <i class="fas fa-user"></i>
                        <span>Thông tin cá nhân</span>
                    </div>
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "days-receipt" ? "active" : "")" data-target="days-receipt">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Hóa đơn hàng tháng</span>
                    </div>
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "room-book" ? "active" : "")" data-target="room-book">
                        <i class="fas fa-bed"></i>
                        <span>Danh sách đặt phòng</span>
                    </div>
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "balance-info" ? "active" : "")" data-target="balance-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Lịch sử giao dịch</span>
                    </div>
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "deposit-history" ? "active" : "")" data-target="deposit-history">
                        <i class="fas fa-history"></i>
                        <span>Nạp tiền</span>
                    </div>
                    <div class="sub-menu-item @(ViewBag.ActiveTab == "issue-report" ? "active" : "")" data-target="issue-report">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Báo cáo sự cố</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="rightContent">
            <div class="content-section @(ViewBag.ActiveTab == "profile" ? "active" : "")" id="profile">
                <div class="profile-container">
                    <h1>Thông tin cá nhân</h1>
                    <form id="profile-form" method="post">
                        <div class="form-group">
                            <label for="display-name">Tên hiển thị</label>
                            <div class="input-wrapper">
                                <input type="text" id="display-name" name="displayName" value="@ViewBag.HoTen">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Hình ảnh đại diện</label>
                            <div class="avatar-upload">
                                <div class="avatar-preview">
                                    @if (!string.IsNullOrEmpty(ViewBag.AvatarUrl))
                                    {
                                        <img src="@ViewBag.AvatarUrl" alt="Avatar">
                                    }
                                    else
                                    {
                                        <img src="@Url.Content("~/asset/avatarUser/default_avatarUser.png")" alt="Default Avatar">
                                    }
                                </div>
                                <button type="button" class="upload-btn">Tải lên hình ảnh</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <div class="input-wrapper">
                                <input type="email" id="email" name="email" value="@ViewBag.Email" readonly>
                                <button type="button" class="btn btn-update" onclick="enableEdit('email')">Cập nhật</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="phone">Số điện thoại</label>
                            <div class="input-wrapper">
                                <input type="tel" id="phone" name="phone" value="@ViewBag.SoDienThoai" readonly>
                                <button type="button" class="btn btn-update" onclick="enableEdit('phone')">Cập nhật</button>
                            </div>
                        </div>
                        <div class="btn-group">
                            <a asp-controller="QuenMatKhau" asp-action="DatLaiMatKhau" class="change-password">Đổi mật khẩu</a>
                            <button type="button" class="btn btn-save" onclick="saveProfile()">Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="content-section @(ViewBag.ActiveTab == "days-receipt" ? "active" : "")" id="days-receipt">

                @if (!string.IsNullOrEmpty(TempData["PayBillErrorMessage"] as string))
                {
                    <div class="alert alert-danger" role="alert">
                        @TempData["PayBillErrorMessage"]
                    </div>
                }
                @if (!string.IsNullOrEmpty(TempData["PayBillSuccessMessage"] as string))
                {
                    <div class="alert alert-success" role="alert">
                        @TempData["PayBillSuccessMessage"]
                    </div>
                }
                <div class="action-bar">
                    <div class="month-year-search-box">
                        <label for="from-month-year">Từ</label>
                        <input type="month" id="from-month-year" name="from-month-year">
                        <label for="to-month-year">Đến</label>
                        <input type="month" id="to-month-year" name="to-month-year">
                        <button id="search-by-month-year-btn"><i class="fas fa-calendar-alt"></i> Tìm kiếm</button>
                        <button id="reset-month-year-search-btn" style="display: none;"><i class="fas fa-times"></i> Xóa</button>
                    </div>
                    <div class="search-box">
                        <input type="number" id="search-hoadon-input" placeholder="Tìm kiếm theo mã hóa đơn" min="0">
                        <button id="search-hoadon-btn"><i class="fas fa-search"></i></button>
                        <button id="reset-hoadon-search-btn" style="display: none;"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="filter-buttons">
                        <label for="filter-hoadon-status">Lọc trạng thái:</label>
                        <select id="filter-hoadon-status" name="filter-hoadon-status">
                            <option value="All">Hiển thị tất cả</option>
                            <option value="NotYetPaid">Hiển thị chưa thanh toán</option>
                        </select>
                    </div>
                </div>
                <div class="hoadon-list">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Mã Hóa Đơn</th>
                                <th scope="col">Mã Hợp Đồng</th>
                                <th scope="col">Tháng</th>
                                <th scope="col">Năm</th>
                                <th scope="col">Chỉ số nước</th>
                                <th scope="col">Chỉ số điện</th>
                                <th scope="col">Tiền Điện</th>
                                <th scope="col">Tiền Nước</th>
                                <th scope="col">Tiền Rác</th>
                                <th scope="col">Tổng Tiền</th>
                                <th scope="col">Ngày Tạo</th>
                                <th scope="col">Trạng Thái</th>
                                <th scope="col">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="hoadon-list-body">
                        </tbody>
                    </table>
                </div>
            </div>
                
            <div class="content-section @(ViewBag.ActiveTab == "room-book" ? "active" : "")" id="room-book">
                <div class="room-search-container">
                    <input type="text" class="room-search-input" placeholder="Tìm kiếm phòng...">
                    <button class="room-search-button">Tìm kiếm</button>
                    <button class="clear-search clear-room-search" onclick="clearRoomSearch()" title="Xóa tìm kiếm">X</button>
                </div>
                <h2>Danh sách phòng đã thuê</h2>
                <div id="rooms-container">
                    <table class="room-table">
                        <thead>
                            <tr>
                                <th>Mã Hợp đồng</th>
                                <th>Mã Phòng</th>
                                <th>Ngày Bắt Đầu</th>
                                <th>Ngày Kết Thúc</th>
                                <th>Tiền Cọc</th>
                                <th>Trạng Thái</th>
                                <th>Ngày Ký</th>
                                <th>Ghi Chú</th>
                                <th>Phương Thức Thanh Toán</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="rooms-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="content-section @(ViewBag.ActiveTab == "balance-info" ? "active" : "")" id="balance-info">
                <div class="balance-container">
                     
                    <h3>Lịch sử giao dịch</h3>
                    <div class="transaction-search">
                        <input type="text" id="transaction-search" placeholder="Tìm theo mã giao dịch">
                        <button class="search-button" onclick="searchTransactions()">Tìm kiếm</button>
                        <button class="clear-search clear-transaction-search" onclick="clearTransactionSearch()" title="Xóa tìm kiếm">X</button>
                    </div>
                    <div class="transaction-history">
                        <table class="transaction-table">
                            <thead>
                                <tr>
                                    <th>Mã giao dịch</th>
                                    <th>Mô tả</th>
                                    <th>Phương thức giao dịch</th>
                                    <th>Số tiền giao dịch</th>
                                    <th>Thời gian giao dịch</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="content-section @(ViewBag.ActiveTab == "deposit-history" ? "active" : "")" id="deposit-history">
                <h3>Bạn hãy chọn hình thức thanh toán</h3>
                <form id="deposit-form" asp-action="NapTien" asp-controller="TrangCaNhan" method="post">
                
                <div class="payment-methods">
                    <!-- Phương thức thanh toán VNPay -->
                        <div class="payment-option" name="PaymentMethod" value="VNPay">
                        <img src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.jpg" alt="VNPay" class="VnPay" />
                        <p>VNPay</p>
                    </div>
                    <div class="payment-option" name="PaymentMethod" value="MoMo">
                        <img src="~/asset/momo-icon.png" alt="MoMo" class="Momo" />
                        <p>Ví MoMo</p>      
                    </div>
                </div>
                    
                <div class="inuput_money">
                    <h3>Nhập số tiền muốn nạp</h3>
                    <input type="text" id="ip_money" placeholder="Nhập số tiền (VND)">
                    <span>Đơn vị VNĐ</span>
                    <button type="submit" id="submitMoney" name="money">Xác nhận</button>
                    <h4>Hotline: <a href="tel:0392574033" class="hotline-payment">0392574033</a></h4>
                </div>

                    <input type="hidden" name="Name" value="@ViewBag.HoTen" />
                    <input type="hidden" name="OrderDescription" value="đã nạp tiền qua VNPay tại Webiste Phòng trọ vui vẻ" />
                    <input type="hidden" name="OrderType" value="other" />
                    <input type="hidden" id="paymentMethod" name="PaymentMethod" value="" />
                    <input type="hidden" id="amountInput" name="Amount" value="" />
                    <input type="hidden" name="OrderId" value="@Guid.NewGuid().ToString()" />
                    <input type="hidden" name="OrderInfo" value="đã nạp tiền qua Momo tại Webiste Phòng trọ vui vẻ" />
                    <input type="hidden" name="FullName" value="@ViewBag.HoTen" />
                    <input type="hidden" name="Email" value="@ViewBag.Email" />
                </form>
            </div>

            <div class="content-section @(ViewBag.ActiveTab == "issue-report" ? "active" : "")" id="issue-report">
                <h2>Gửi báo cáo sự cố</h2>
                <form id="issue-report-form" method="post" asp-action="SubmitIssue" asp-controller="TrangCaNhan" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="MaPhong">Phòng/Địa điểm</label>
                        <select id="MaPhong" name="MaPhong" required>
                            @if (ViewBag.Rooms != null && ((List<PhongTroModel>)ViewBag.Rooms).Any())
                            {
                                foreach (var room in (List<PhongTroModel>)ViewBag.Rooms)
                                {
                                    <option value="@room.MaPhong">@room.TenPhong (@room.DiaChi)</option>
                                }
                            }
                            else
                            {
                                <option value="" disabled>Không có phòng nào</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issueType">Loại sự cố</label>
                        <input type="text" id="issueType" name="LoaiSuCo" list="issueTypeList" required placeholder="Chọn hoặc nhập loại sự cố">
                        <datalist id="issueTypeList">
                            <option value="Hỏng điện">Hỏng điện</option>
                            <option value="Mất nước">Mất nước</option>
                            <option value="Tắc cống">Tắc cống</option>
                            <option value="Hỏng thiết bị">Hỏng thiết bị</option>
                            <option value="Chuột/Côn trùng">Chuột/Côn trùng</option>
                            <option value="Vấn đề an ninh">Vấn đề an ninh</option>
                            <option value="Khác">Khác</option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="moTa">Mô tả chi tiết</label>
                        <textarea id="moTa" name="MoTa" rows="4" placeholder="Mô tả chi tiết về sự cố (ví dụ: Máy lạnh phòng 203 không lạnh, có tiếng ồn lạ)" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="media">Hình ảnh/Video</label>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Giới hạn: Video tối đa 40MB, hình ảnh 10MB
                        </small>
                        <input type="file" id="media" name="media" accept="image/*,video/*" multiple>
                        <div id="media-preview" class="media-preview"></div>
                    </div>
                    <div class="form-group">
                        <label for="priority">Mức độ ưu tiên</label>
                        <select id="priority" name="priority">
                            <option value="BinhThuong">Bình thường</option>
                            <option value="QuanTrong">Quan trọng</option>
                            <option value="KhanCap">Khẩn cấp</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="phone">Số điện thoại liên hệ</label>
                        <div class="input-wrapper">
                            <input type="tel" id="phone" name="DienThoai" value="@ViewBag.SoDienThoai" >
                            
                        </div>
                    </div>
                    <button type="submit" class="btn btn-submit">Gửi báo cáo</button>
                </form>

            </div>
        </div>
    </div> 
    <script>
        window.tempData = {
            successMessage: '@Html.Raw(Json.Serialize(TempData["SuccessMessage"]))'.replace(/\\u[0-9a-fA-F]{4}/g, match => String.fromCharCode(parseInt(match.replace(/\\u/, ''), 16))),
            errorMessage: '@Html.Raw(Json.Serialize(TempData["ErrorMessage"]))'.replace(/\\u[0-9a-fA-F]{4}/g, match => String.fromCharCode(parseInt(match.replace(/\\u/, ''), 16)))
        };
        window.MaNguoiDung = '@ViewBag.MaNguoiDung';
        window.ActiveTab = '@ViewBag.ActiveTab';
        
    </script>
    <script src="~/js/siteTrangCaNhan.js"></script>
</body>
</html>