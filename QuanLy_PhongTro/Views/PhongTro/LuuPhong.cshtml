@model IEnumerable<IGrouping<LoaiPhongModel, PhongTroModel>>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách phòng đã lưu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="~/lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/siteLuuPhong.css">
    <meta name="csrf-token" content="@ViewData["CSRFToken"]" />
</head>
<body>
    <div class="container">
        <h1>Danh sách phòng đã lưu</h1>
        @if (!User.Identity.IsAuthenticated)
        {
            <div class="alert alert-warning">
                Bạn cần <a asp-controller="DangNhap" asp-action="Index">Đăng nhập</a> để xem danh sách phòng đã lưu.
            </div>
        }
        else
        {
            @if (!Model.Any())
            {
                <p class="list-romsave">Bạn chưa lưu phòng nào.</p>
            }
            else
            {
                <div class="dropdown-actions">
                    <button class="btn btn-danger" onclick="clearSavedRooms()">Xóa tất cả</button>
                </div>

                <div class="room-list">
                    @foreach (var nhom in Model)
                    {
                        @foreach (var item in nhom)
                        {
                            <div class="room-card" onclick="viewRoomDetail('@item.MaPhong')">
                                <div class="save-icon" onclick="deleteSavedRoom(event, '@item.MaPhong')">
                                    <i class="fas fa-trash"></i>
                                </div>

                                @if (item.AnhPhongTros != null && item.AnhPhongTros.Any(a => a.LaAnhDaiDien))
                                {
                                    <img src="~/asset/@item.AnhPhongTros.First(a => a.LaAnhDaiDien).DuongDan" alt="@item.TenPhong" class="room-image">
                                }
                                else
                                {
                                    <img src="~/asset/default-room.jpg" alt="@item.TenPhong" class="room-image">
                                }

                                <div class="room-content">
                                    <div class="room-header">
                                        <h2>@item.TenPhong</h2>
                                    </div>
                                    <div class="room-address">
                                        <i class="fas fa-map-marker-alt"></i> @item.DiaChi
                                    </div>
                                    <div class="room-price-area">
                                        <span class="price">@item.GiaThue.ToString("N0")</span>
                                        <span class="area">@item.DienTich m²</span>
                                    </div>
                                    <div class="room-features">
                                        @if (item.MaLoaiPhong == 1)
                                        {
                                            <span><i class="fas fa-home"></i> Phòng trọ</span>
                                        }
                                        else
                                        {
                                            <span><i class="fas fa-building"></i> Nguyên căn</span>
                                        }

                                        @if (item.PhongTroThietBis != null)
                                        {
                                            @foreach (var tb in item.PhongTroThietBis.Take(2))
                                            {
                                                <span>@tb.ThietBi?.TenThietBi</span>
                                            }
                                        }
                                    </div>
                                    <div class="room-poster">
                                        <span class="poster-name">Quản lý</span>
                                        <span class="room-status @(item.TrangThai == "Trống" ? "available" : "rented")">
                                            @item.TrangThai
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        }

    </div>
    <div class="notification-container" id="notificationContainer"></div>
    <script>
        function showNotification(type, message) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            notification.innerHTML = `
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} notification-icon"></i>
                        <div class="notification-content">
                            <div class="notification-title">${type === 'success' ? 'Thành công' : 'Lỗi'}</div>
                            <div>${message}</div>
                        </div>
                        <button class="notification-close" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

            container.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function viewRoomDetail(maPhong) {
            window.location.href = '/phong-tro/chi-tiet/' + maPhong;
        }

        function deleteSavedRoom(event, maPhong) {
            event.stopPropagation();

            if (confirm('Bạn có chắc chắn muốn xóa phòng này khỏi danh sách đã lưu?')) {
                const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                fetch(`/luu-phong/delete/${maPhong}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        ...(token && { 'X-CSRF-TOKEN': token })
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('success', data.message);
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showNotification('error', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('error', 'Đã có lỗi xảy ra khi xóa phòng.');
                    });
            }
        }

        function clearSavedRooms() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả phòng đã lưu?')) {
                const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                fetch('/phong-tro/xoa-tat-ca-luu-phong', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        ...(token && { 'X-CSRF-TOKEN': token })
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('success', data.message);
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showNotification('error', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('error', 'Đã có lỗi xảy ra khi xóa tất cả phòng.');
                    });
            }
        }
    </script>
</body>
</html>